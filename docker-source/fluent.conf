<label @FLUENT_LOG>
  <match>
    @type null
  </match>
</label>

<source>
  @type sample
  auto_increment_key indice
  tag teste
</source>

<filter **>
  @type record_transformer
  enable_ruby
  <record>
    tenantid ${"tenant-#{record['indice'].to_i % 5}"}
  </record>
</filter>

<match **>
  @type copy

  <store>
    @type stdout
  </store>

  <store>
    @type s3

    enable_ruby

    s3_endpoint https://s3.i02.estaleiro.serpro.gov.br
    s3_region us-east-1
    aws_key_id RX9DEI7P5WG51ND29VFN
    aws_sec_key 3TpiUPQf04m6QWO6OdElheJhImYzSSuAce2dDe1a
    s3_bucket no_tenant_fallback
    s3_bucket_key tenantid
    s3_object_key_format events_%{time_slice}_%{index}.%{file_extension}
    format json

    <buffer time,tenantid>
	timekey 10s
       	flush_interval 5s
       	timekey_wait 5s
    </buffer>

    # <buffer tag,time>
    #   timekey 10s
    #   timekey_wait 12s
    #   flush_interval 15s
    # </buffer>

  </store>
</match>
